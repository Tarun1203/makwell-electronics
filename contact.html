<!DOCTYPE html>
<html lang="en" data-theme="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contact • MakWell Support</title>
  <meta name="description" content="MakWell — product registration, support, repair requests, WhatsApp and email support." />
  <link rel="icon" href="https://raw.githubusercontent.com/Tarun1203/makwell-electronics/main/images/Makwell-logo.png">
  <link rel="stylesheet" href="styles.css" />
  <script defer src="theme.js"></script>

  <style>
    :root { --container: 1100px; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; color: var(--text); background: var(--bg); line-height: 1.6; }
    .container { max-width: var(--container); margin: 0 auto; padding: 16px; }
    
    header.site { border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    nav.container { display: flex; align-items: center; gap: 12px; justify-content: space-between; padding: 12px 16px; }
    .brand { display: flex; gap: 10px; align-items: center; text-decoration: none; color: inherit; transition: opacity 0.2s; }
    .brand:hover { opacity: 0.8; }
    .brand img { width: 40px; height: 40px; object-fit: contain; border-radius: 6px; }
    .navlinks { display: flex; gap: 10px; align-items: center; }
    .navlinks a { text-decoration: none; color: inherit; padding: 6px 12px; border-radius: 8px; transition: background 0.2s; font-size: 15px; }
    .navlinks a:hover { background: var(--hover); }
    .navlinks a.active { font-weight: 700; background: var(--hover); }

    main { padding: 20px 0 40px; }
    .hero { text-align: center; padding: 24px 0; }
    .hero h1 { margin: 4px 0; font-size: 32px; font-weight: 800; }
    .hero p { margin: 8px auto 0; max-width: 760px; }
    .two { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; margin-top: 24px; }
    @media (max-width: 900px) { .two { grid-template-columns: 1fr; } .hero h1 { font-size: 26px; } }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; box-shadow: var(--shadow); }
    .card h2, .card h3 { margin: 0 0 12px; font-weight: 700; }

    label { display: block; font-weight: 600; margin-top: 12px; margin-bottom: 6px; font-size: 14px; color: var(--text); }
    label:first-of-type { margin-top: 0; }
    input[type="text"], input[type="tel"], input[type="email"], select, textarea, input[type="date"] {
      width: 100%; padding: 11px 13px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: inherit; font: inherit; box-sizing: border-box; transition: all 0.2s; font-size: 15px;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
    input::placeholder, textarea::placeholder { color: var(--muted); }
    textarea { resize: vertical; min-height: 100px; font-family: inherit; }
    select { cursor: pointer; }

    .btn { display: inline-block; background: var(--accent); color: #fff; padding: 11px 18px; border-radius: 10px; border: 0; cursor: pointer; font-weight: 700; text-decoration: none; transition: all 0.2s; font-size: 15px; text-align: center; font-family: inherit; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.secondary { background: transparent; color: inherit; border: 1px solid var(--border); }
    .btn.secondary:hover { background: var(--hover); opacity: 1; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    .note { font-size: 13px; color: var(--muted); margin-top: 6px; line-height: 1.5; }
    .small { font-size: 13px; color: var(--muted); }
    .result { margin-top: 16px; padding: 16px; border-radius: 10px; border: 1px solid var(--border); background: color-mix(in oklab, var(--accent) 6%, var(--bg)); animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .success { color: #28a745; font-weight: 700; }
    .error { color: #dc3545; font-weight: 700; }
    .warning { color: #ff6b00; font-weight: 600; }

    .warranty-badge { display: inline-block; padding: 10px 18px; border-radius: 20px; font-size: 14px; font-weight: 700; margin-top: 12px; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .warranty-badge.valid { background: #28a745; color: white; }
    .warranty-badge.expired { background: #dc3545; color: white; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .grid-2:first-of-type { margin-top: 0; }
    @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }

    footer.site { text-align: center; padding: 30px 12px; border-top: 1px solid var(--border); margin-top: 50px; background: var(--panel); }
    #warrantyChecker { animation: slideIn 0.3s ease; margin-bottom: 24px; }

    .contact-item { margin-bottom: 14px; padding: 10px; border-radius: 8px; transition: background 0.2s; }
    .contact-item:hover { background: var(--hover); }
    .contact-item strong { display: block; margin-bottom: 4px; font-size: 14px; }
    .contact-item a { color: var(--accent); text-decoration: none; font-weight: 500; }
    .contact-item a:hover { text-decoration: underline; }

    .required-star { color: #dc3545; font-weight: 700; }
    
    .error-banner { background: #f8d7da; color: #721c24; padding: 12px 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #dc3545; }
    .error-banner strong { display: block; margin-bottom: 4px; }
    
    @media (max-width: 600px) { .card { padding: 18px; } nav.container { flex-wrap: wrap; } .navlinks { font-size: 14px; } }
  </style>
</head>
<body>
  <header class="site">
    <nav class="container" aria-label="Main navigation">
      <a class="brand" href="index.html" aria-label="MakWell home">
        <img src="https://raw.githubusercontent.com/Tarun1203/makwell-electronics/main/images/Makwell-logo.png" alt="MakWell logo">
        <div>
          <div style="font-weight:800; font-size:18px">MakWell</div>
          <div class="small">Make it Happen</div>
        </div>
      </a>
      <div class="navlinks" role="navigation" aria-label="Top links">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="about.html">About</a>
        <a href="contact.html" class="active">Contact</a>
        <button id="themeToggle" aria-label="Toggle theme" onclick="toggleTheme()" class="btn secondary" style="padding:8px 12px; font-size:18px">🌓</button>
      </div>
    </nav>
  </header>

  <main class="container">
    <section class="hero">
      <h1 id="pageTitle">Need help? Submit a request</h1>
      <p class="small muted" id="pageDesc">Product registration, product support, and repair requests — use the form below.</p>
      <div id="warrantyBadgeContainer"></div>
    </section>

    <section id="mainContent">
      <div class="two">
        <form id="supportForm" class="card" autocomplete="on" novalidate>
          <h2>Create Ticket</h2>

          <label for="type">Request Type <span class="required-star">*</span></label>
          <select id="type" required>
            <option value="">Select request type</option>
            <option value="Product Registration">Product Registration</option>
            <option value="Product Support">Product Support</option>
            <option value="Repair Request">Repair Request</option>
          </select>

          <div class="grid-2">
            <div>
              <label for="customer">Customer Name <span class="required-star">*</span></label>
              <input id="customer" type="text" placeholder="Full name" required autocomplete="name">
            </div>
            <div>
              <label for="phone">Phone <span class="required-star">*</span></label>
              <input id="phone" type="tel" placeholder="10-digit mobile" pattern="[0-9]{10}" required autocomplete="tel">
            </div>
          </div>

          <label for="email">Email (optional)</label>
          <input id="email" type="email" placeholder="name@example.com" autocomplete="email">

          <div class="grid-2">
            <div>
              <label for="category">Product Category <span class="required-star">*</span></label>
              <select id="category" required>
                <option value="">Select category</option>
                <option value="Televisions">Televisions</option>
                <option value="Washing Machines">Washing Machines</option>
                <option value="Refrigerators">Refrigerators</option>
                <option value="Air Conditioners">Air Conditioners</option>
                <option value="Stabilizers">Stabilizers</option>
                <option value="Microwave Ovens">Microwave Ovens</option>
                <option value="Water Purifiers">Water Purifiers</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label for="model">Model <span class="required-star">*</span></label>
              <input id="model" type="text" placeholder='e.g., 43" Smart TV' required>
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label for="serial">Serial Number (optional)</label>
              <input id="serial" type="text" placeholder="Serial number">
            </div>
            <div>
              <label for="purchaseDate">Purchase Date <span id="purchaseDateRequired"></span></label>
              <input id="purchaseDate" type="date" max="">
            </div>
          </div>

          <div class="grid-2" id="warrantySection">
            <div>
              <label for="warranty">Under Warranty <span class="required-star">*</span></label>
              <select id="warranty" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div id="warrantyNote" class="note" aria-live="polite"></div>
            </div>
            <div id="issueTypeSection">
              <label for="issueType">Issue Type (optional)</label>
              <select id="issueType">
                <option value="">—</option>
                <option value="Installation">Installation</option>
                <option value="Usage Help">Usage Help</option>
                <option value="Connectivity">Connectivity</option>
                <option value="No Power">No Power</option>
                <option value="Physical Damage">Physical Damage</option>
                <option value="Noise/Vibration">Noise/Vibration</option>
                <option value="Performance Issue">Performance Issue</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <label for="issue">Issue Description <span id="issueRequired"></span></label>
          <textarea id="issue" placeholder="Brief description of the issue or request"></textarea>

          <div class="grid-2">
            <div>
              <label for="city">City</label>
              <input id="city" type="text" placeholder="City">
            </div>
            <div>
              <label for="state">State</label>
              <input id="state" type="text" placeholder="State">
            </div>
          </div>

          <div id="formNote" class="note" style="margin-top:14px; min-height:20px; font-weight:600" aria-live="polite"></div>

          <div style="margin-top:18px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <button id="submitBtn" class="btn" type="submit">Create Ticket</button>
            <button type="reset" class="btn secondary">Clear Form</button>
          </div>

          <div id="ticketResult" class="result" style="display:none" aria-live="polite">
            <div><strong id="ticketHeadline" style="font-size:16px"></strong></div>
            <div id="ticketInfo" class="small" style="margin-top:8px"></div>
            <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap">
              <a id="openWhatsApp" class="btn" target="_blank" rel="noopener">📱 Open WhatsApp</a>
              <a id="openEmail" class="btn secondary" target="_blank" rel="noopener">✉️ Email</a>
              <button id="copyCallId" class="btn secondary">📋 Copy ID</button>
            </div>
          </div>
        </form>

        <aside>
          <div class="card">
            <h3>Quick Contacts</h3>
            <p class="small muted" style="margin:0 0 14px">For immediate assistance:</p>
            
            <div class="contact-item">
              <strong>📦 Orders / Live Chat</strong>
              <a href="https://api.whatsapp.com/send?phone=919980000515" target="_blank" rel="noopener">+91 99800 00515</a>
            </div>
            
            <div class="contact-item">
              <strong>🔧 Service / Repair</strong>
              <a href="https://api.whatsapp.com/send?phone=919482844677" target="_blank" rel="noopener">+91 94828 44677</a>
            </div>
            
            <div class="contact-item">
              <strong>✉️ Email Support</strong>
              <a href="mailto:makwellindia456@gmail.com">makwellindia456@gmail.com</a>
            </div>
            
            <hr style="margin:16px 0; border:none; border-top:1px solid var(--border)">
            
            <p class="small muted" style="margin:0 0 16px">
              <strong>Support Hours:</strong><br>Monday–Saturday<br>9:30 AM – 6:30 PM IST
            </p>

            <div style="display:flex; flex-direction:column; gap:10px">
              <a href="contact.html?action=register" class="btn secondary">📝 Register Product</a>
              <a href="contact.html?action=warranty" class="btn secondary">🛡️ Check Warranty</a>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <footer class="site">
    <div class="container small muted">© <span id="year"></span> MakWell — Make it Happen</div>
  </footer>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbw0AiC6HEecS_ZyXI49I3VTPLTdW_068zJJCeTKh0T6Hn0As2FUSLIKMnGz4iCG1t_4/exec";
    const WEB_SECRET = "MakWell2024SecureKey";
    const OPS_WHATSAPP = "919482844677";
    const ORDERS_WHATSAPP = "919980000515";

    const WARRANTY_PERIODS = {
      'Televisions': 12, 'Washing Machines': 24, 'Refrigerators': 12,
      'Air Conditioners': 12, 'Stabilizers': 12, 'Microwave Ovens': 12,
      'Water Purifiers': 12, 'Other': 12, 'Default': 12
    };

    // ========================================
    // ERROR LOGGING
    // ========================================
    function logError(context, error) {
      console.error(`[${context}] Error:`, error);
      if(error.stack) console.error('Stack:', error.stack);
    }

    function showErrorBanner(message, details = '') {
      const banner = document.createElement('div');
      banner.className = 'error-banner';
      banner.innerHTML = `
        <strong>❌ Error</strong>
        ${message}
        ${details ? `<div class="small" style="margin-top:6px">${details}</div>` : ''}
      `;
      document.querySelector('main .container').insertBefore(banner, document.getElementById('mainContent'));
      setTimeout(() => banner.remove(), 10000);
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function getUrlParam(param) {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      } catch(e) {
        logError('getUrlParam', e);
        return null;
      }
    }

    function prefixFor(type){
      if(!type) return "XX";
      if(type.includes("Registration")) return "PR";
      if(type.includes("Support")) return "PS";
      if(type.includes("Repair")) return "RR";
      return "XX";
    }

    function pad3(n){ return String(n).padStart(3,'0'); }
    function twoDigitYear(){ return new Date().getFullYear().toString().slice(-2); }

    // ========================================
    // WARRANTY CALCULATION
    // ========================================
    function calculateWarrantyExpiry(purchaseDate, category) {
      try {
        if(!purchaseDate) return null;
        const purchase = new Date(purchaseDate);
        if(isNaN(purchase.getTime())) return null;
        
        const warrantyMonths = WARRANTY_PERIODS[category] || WARRANTY_PERIODS['Default'];
        const expiry = new Date(purchase);
        expiry.setMonth(expiry.getMonth() + warrantyMonths);
        return expiry;
      } catch(e) {
        logError('calculateWarrantyExpiry', e);
        return null;
      }
    }

    function isUnderWarranty(purchaseDate, category) {
      try {
        const expiryDate = calculateWarrantyExpiry(purchaseDate, category);
        if(!expiryDate) return false;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return today <= expiryDate;
      } catch(e) {
        logError('isUnderWarranty', e);
        return false;
      }
    }

    function getRemainingWarrantyDays(purchaseDate, category) {
      try {
        const expiryDate = calculateWarrantyExpiry(purchaseDate, category);
        if(!expiryDate) return 0;
        const today = new Date();
        const diffTime = expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return Math.max(0, diffDays);
      } catch(e) {
        logError('getRemainingWarrantyDays', e);
        return 0;
      }
    }

    // ========================================
    // AUTO-CHECK WARRANTY
    // ========================================
    function autoCheckWarranty() {
      try {
        const purchaseDate = document.getElementById('purchaseDate').value;
        const category = document.getElementById('category').value;
        const warrantyField = document.getElementById('warranty');
        const warrantyNote = document.getElementById('warrantyNote');
        const badgeContainer = document.getElementById('warrantyBadgeContainer');
        
        if(!purchaseDate || !category) {
          warrantyNote.innerHTML = '';
          badgeContainer.innerHTML = '';
          return;
        }
        
        const underWarranty = isUnderWarranty(purchaseDate, category);
        const remainingDays = getRemainingWarrantyDays(purchaseDate, category);
        const expiryDate = calculateWarrantyExpiry(purchaseDate, category);
        
        if(!expiryDate) {
          warrantyNote.innerHTML = '<span class="error">Invalid purchase date</span>';
          return;
        }
        
        warrantyField.value = underWarranty ? 'Yes' : 'No';
        
        if(underWarranty) {
          warrantyNote.innerHTML = `
            <span class="success">✓ Under Warranty</span><br>
            <span style="font-size:12px">${remainingDays} days remaining • Expires: ${expiryDate.toLocaleDateString('en-IN')}</span>
          `;
          badgeContainer.innerHTML = `<div class="warranty-badge valid">✓ Valid Warranty • ${remainingDays} days remaining</div>`;
        } else {
          warrantyNote.innerHTML = `
            <span class="error">✗ Warranty Expired</span><br>
            <span style="font-size:12px">Expired: ${expiryDate.toLocaleDateString('en-IN')}</span>
          `;
          badgeContainer.innerHTML = `<div class="warranty-badge expired">✗ Warranty Expired</div>`;
        }
        
        maybeWarn();
      } catch(e) {
        logError('autoCheckWarranty', e);
      }
    }

    // ========================================
    // FORM VALIDATION
    // ========================================
    function maybeWarn(){
      try {
        const type = document.getElementById('type').value;
        const warranty = document.getElementById('warranty').value;
        const purchaseDate = document.getElementById('purchaseDate').value;
        const category = document.getElementById('category').value;
        const formNote = document.getElementById('formNote');
        
        if(type === 'Product Support' && warranty && warranty !== 'Yes'){
          formNote.innerHTML = `
            <span class="warning">⚠ Product Support requires active warranty.</span><br>
            <span style="font-size:12px">This will be logged as <strong>Repair Request</strong> (chargeable service).</span>
          `;
        } 
        else if(warranty === 'Yes' && purchaseDate && category) {
          const actuallyUnderWarranty = isUnderWarranty(purchaseDate, category);
          if(!actuallyUnderWarranty) {
            formNote.innerHTML = `<span class="warning">⚠ Warning:</span> Based on purchase date, warranty appears expired. Please verify.`;
          } else {
            formNote.textContent = "";
          }
        }
        else {
          formNote.textContent = "";
        }
      } catch(e) {
        logError('maybeWarn', e);
      }
    }

    // ========================================
    // LINK BUILDERS
    // ========================================
    function buildWhatsAppLink(phone, obj){
      try {
        const p = String(phone||"").replace(/\D/g,'');
        const lines = [
          `📋 Call ID: ${obj.callId}`, `📌 Type: ${obj.type}`, `👤 Name: ${obj.customer}`,
          `📱 Phone: +91 ${obj.phone}`, `📧 Email: ${obj.email || '-'}`, ``,
          `🏷️ Category: ${obj.category || '-'}`, `📦 Model: ${obj.model || '-'}`,
          `🔢 Serial: ${obj.serial || '-'}`, `📅 Purchase Date: ${obj.purchaseDate || '-'}`,
          `🛡️ Under Warranty: ${obj.warranty || '-'}`, ``,
          `⚠️ Issue Type: ${obj.issueType || '-'}`, `📝 Description: ${obj.issue || '-'}`, ``,
          `📍 Location: ${obj.city || '-'}, ${obj.state || '-'}`
        ];
        return `https://api.whatsapp.com/send?phone=${p}&text=${encodeURIComponent(lines.join("\n"))}`;
      } catch(e) {
        logError('buildWhatsAppLink', e);
        return `https://api.whatsapp.com/send?phone=${phone}`;
      }
    }

    function buildMailTo(obj){
      try {
        const sub = `New ${obj.type} Ticket - ${obj.callId}`;
        const body = [
          `Call ID: ${obj.callId}`, `Type: ${obj.type}`, ``, `CUSTOMER DETAILS:`,
          `Name: ${obj.customer}`, `Phone: +91 ${obj.phone}`, `Email: ${obj.email || '-'}`, ``,
          `PRODUCT DETAILS:`, `Category: ${obj.category || '-'}`, `Model: ${obj.model || '-'}`,
          `Serial: ${obj.serial || '-'}`, `Purchase Date: ${obj.purchaseDate || '-'}`,
          `Under Warranty: ${obj.warranty || '-'}`, ``, `ISSUE DETAILS:`,
          `Issue Type: ${obj.issueType || '-'}`, `Description: ${obj.issue || '-'}`, ``,
          `LOCATION:`, `City: ${obj.city || '-'}`, `State: ${obj.state || '-'}`
        ].join("\n");
        return `mailto:makwellindia456@gmail.com?subject=${encodeURIComponent(sub)}&body=${encodeURIComponent(body)}`;
      } catch(e) {
        logError('buildMailTo', e);
        return 'mailto:makwellindia456@gmail.com';
      }
    }

    // ========================================
    // WARRANTY CHECKER
    // ========================================
    function showWarrantyChecker() {
      try {
        const warrantyCheckerHTML = `
          <div class="card" id="warrantyChecker">
            <h2>Check Warranty Status</h2>
            <p class="small muted">Enter your product details to verify warranty status.</p>
            <div class="grid-2" style="margin-top:16px">
              <div>
                <label for="checkSerial">Serial Number <span class="required-star">*</span></label>
                <input id="checkSerial" type="text" placeholder="Enter serial number" required>
              </div>
              <div>
                <label for="checkPhone">Registered Phone <span class="required-star">*</span></label>
                <input id="checkPhone" type="tel" placeholder="10-digit mobile" pattern="[0-9]{10}" required>
              </div>
            </div>
            <button id="checkWarrantyBtn" class="btn" style="margin-top:14px">🔍 Check Warranty Status</button>
            <div id="warrantyResult" class="result" style="display:none; margin-top:14px">
              <div id="warrantyStatus"></div>
            </div>
          </div>
        `;
        
        const mainContent = document.getElementById('mainContent');
        mainContent.insertAdjacentHTML('afterbegin', warrantyCheckerHTML);
        document.getElementById('checkWarrantyBtn').addEventListener('click', checkWarrantyStatus);
      } catch(e) {
        logError('showWarrantyChecker', e);
      }
    }

    async function checkWarrantyStatus() {
      const serial = document.getElementById('checkSerial').value.trim();
      const phone = document.getElementById('checkPhone').value.trim();
      const resultDiv = document.getElementById('warrantyResult');
      const statusDiv = document.getElementById('warrantyStatus');
      const btn = document.getElementById('checkWarrantyBtn');
      
      try {
        if(!serial || !phone) {
          statusDiv.innerHTML = '<span class="error">⚠ Please enter both serial number and phone.</span>';
          resultDiv.style.display = 'block';
          return;
        }

        if(!/^[0-9]{10}$/.test(phone)) {
          statusDiv.innerHTML = '<span class="error">⚠ Phone number must be 10 digits.</span>';
          resultDiv.style.display = 'block';
          return;
        }
        
        btn.disabled = true;
        btn.textContent = '🔍 Checking...';
        statusDiv.innerHTML = '<span>🔍 Searching warranty records...</span>';
        resultDiv.style.display = 'block';
        
        console.log('Checking warranty for:', { serial, phone });
        
        const response = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            action: 'checkWarranty',
            serial: serial,
            phone: phone,
            secret: WEB_SECRET
          })
        });
        
        console.log('Response status:', response.status);
        
        if(!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Warranty check result:', result);
        
        if(result.found) {
          const underWarranty = isUnderWarranty(result.purchaseDate, result.category);
          const remainingDays = getRemainingWarrantyDays(result.purchaseDate, result.category);
          const expiryDate = calculateWarrantyExpiry(result.purchaseDate, result.category);
          
          const bgColor = underWarranty ? '#d4edda' : '#f8d7da';
          const textColor = underWarranty ? '#155724' : '#721c24';
          const warrantyMonths = WARRANTY_PERIODS[result.category] || 12;
          
          statusDiv.innerHTML = `
            <div style="margin-bottom:14px; padding-bottom:14px; border-bottom:1px solid var(--border)">
              <strong style="font-size:15px">Product Information</strong><br>
              <div style="margin-top:8px; line-height:1.8">
                <strong>Model:</strong> ${result.model || 'N/A'}<br>
                <strong>Category:</strong> ${result.category || 'N/A'}<br>
                <strong>Serial Number:</strong> ${result.serial || 'N/A'}<br>
                <strong>Customer:</strong> ${result.customer || 'N/A'}
              </div>
            </div>
            <div style="margin-bottom:14px; padding-bottom:14px; border-bottom:1px solid var(--border)">
              <strong style="font-size:15px">Warranty Information</strong><br>
              <div style="margin-top:8px; line-height:1.8">
                <strong>Purchase Date:</strong> ${new Date(result.purchaseDate).toLocaleDateString('en-IN')}<br>
                <strong>Warranty Period:</strong> ${warrantyMonths} months<br>
                <strong>Warranty Expiry:</strong> ${expiryDate.toLocaleDateString('en-IN')}
              </div>
            </div>
            <div style="padding:14px; border-radius:8px; background:${bgColor}; color:${textColor}; font-weight:700; text-align:center; font-size:16px">
              ${underWarranty 
                ? `✓ UNDER WARRANTY<br><span style="font-size:14px; font-weight:400; margin-top:4px; display:block">${remainingDays} days remaining</span>` 
                : `✗ WARRANTY EXPIRED<br><span style="font-size:14px; font-weight:400; margin-top:4px; display:block">Expired ${Math.abs(remainingDays)} days ago</span>`
              }
            </div>
          `;
        } else {
          statusDiv.innerHTML = `
            <span class="error" style="font-size:15px">❌ No Product Registration Found</span><br>
            <div class="note" style="margin-top:10px; text-align:center">
              Product not registered or details don't match our records.<br>
              <a href="contact.html?action=register" style="font-weight:600">Register Your Product</a>
            </div>
          `;
        }
      } catch(err) {
        logError('checkWarrantyStatus', err);
        statusDiv.innerHTML = `
          <span class="error">❌ Error checking warranty</span><br>
          <div class="note" style="margin-top:8px">
            ${err.message || 'Unable to connect to server. Please try again.'}
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = '🔍 Check Warranty Status';
      }
    }

    // ========================================
    // PAGE INITIALIZATION
    // ========================================
    window.addEventListener('DOMContentLoaded', function() {
      try {
        console.log('Page loaded, initializing...');
        
        document.getElementById('year').textContent = new Date().getFullYear();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('purchaseDate').setAttribute('max', today);

        const action = getUrlParam('action');
        console.log('Action parameter:', action);
        
        const pageTitle = document.getElementById('pageTitle');
        const pageDesc = document.getElementById('pageDesc');
        const typeField = document.getElementById('type');
        const warrantySection = document.getElementById('warrantySection');
        const purchaseDateRequired = document.getElementById('purchaseDateRequired');
        const issueRequired = document.getElementById('issueRequired');
        
        switch(action) {
          case 'register':
            pageTitle.textContent = '📝 Product Registration';
            pageDesc.textContent = 'Register your MakWell product for warranty activation and exclusive benefits.';
            typeField.value = 'Product Registration';
            typeField.disabled = true;
            warrantySection.style.display = 'none';
            document.getElementById('purchaseDate').required = true;
            purchaseDateRequired.innerHTML = '<span class="required-star">*</span>';
            break;
            
          case 'service':
            pageTitle.textContent = '🔧 Product Service Request';
            pageDesc.textContent = 'Request technical support or repair service for your MakWell product.';
            typeField.value = 'Product Support';
            const regOption = Array.from(typeField.options).find(opt => opt.value === 'Product Registration');
            if(regOption) regOption.remove();
            document.getElementById('issue').required = true;
            issueRequired.innerHTML = '<span class="required-star">*</span>';
            break;
            
          case 'warranty':
            pageTitle.textContent = '🛡️ Warranty Information & Status Check';
            pageDesc.textContent = 'Check your product warranty status and submit warranty-related inquiries.';
            showWarrantyChecker();
            break;
        }

        document.getElementById('type').addEventListener('change', maybeWarn);
        document.getElementById('warranty').addEventListener('change', maybeWarn);
        document.getElementById('purchaseDate').addEventListener('change', () => {
          autoCheckWarranty();
          maybeWarn();
        });
        document.getElementById('category').addEventListener('change', () => {
          autoCheckWarranty();
          maybeWarn();
        });

        const form = document.getElementById('supportForm');
        form.addEventListener('submit', handleFormSubmit);
        
        form.addEventListener('reset', () => {
          document.getElementById('ticketResult').style.display = 'none';
          document.getElementById('formNote').textContent = '';
          document.getElementById('warrantyNote').innerHTML = '';
          document.getElementById('warrantyBadgeContainer').innerHTML = '';
        });
        
        console.log('✅ Initialization complete');
      } catch(e) {
        logError('DOMContentLoaded', e);
        showErrorBanner('Failed to initialize page', 'Please refresh the page. If the problem persists, contact support.');
      }
    });

    // ========================================
    // FORM SUBMISSION
    // ========================================
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const formNote = document.getElementById('formNote');
      const ticketResult = document.getElementById('ticketResult');
      const ticketHeadline = document.getElementById('ticketHeadline');
      const ticketInfo = document.getElementById('ticketInfo');
      const submitBtn = document.getElementById('submitBtn');
      
      try {
        console.log('Form submitted');
        
        ticketResult.style.display = 'none';
        formNote.innerHTML = '<span style="color:var(--accent)">⏳ Submitting your request...</span>';
        submitBtn.disabled = true;

        const data = {
          type: (document.getElementById('type').value || '').trim(),
          customer: (document.getElementById('customer').value || '').trim(),
          phone: (document.getElementById('phone').value || '').trim(),
          email: (document.getElementById('email').value || '').trim(),
          category: (document.getElementById('category').value || '').trim(),
          model: (document.getElementById('model').value || '').trim(),
          serial: (document.getElementById('serial').value || '').trim(),
          purchaseDate: (document.getElementById('purchaseDate').value || '').trim(),
          warranty: (document.getElementById('warranty').value || '').trim(),
          issueType: (document.getElementById('issueType').value || '').trim(),
          issue: (document.getElementById('issue').value || '').trim(),
          city: (document.getElementById('city').value || '').trim(),
          state: (document.getElementById('state').value || '').trim(),
          source: 'Web Form',
          secret: WEB_SECRET
        };

        console.log('Form data:', { ...data, secret: '***' });

        if(data.type === 'Product Support' && data.warranty !== 'Yes') {
          data.type = 'Repair Request';
          console.log('Converted to Repair Request due to warranty status');
        }

        const pref = prefixFor(data.type);
        const localCount = Math.floor(Math.random()*900) + 1;
        const provisionalId = `${twoDigitYear()}/MK-${pref}-${pad3(localCount)}`;
        
        console.log('Provisional ID:', provisionalId);
        
        ticketHeadline.innerHTML = '<span class="success">Creating your ticket...</span>';
        ticketInfo.textContent = `Provisional ID: ${provisionalId}`;
        ticketResult.style.display = 'block';

        console.log('Sending to:', GAS_ENDPOINT);
        
        const response = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        
        console.log('Response status:', response.status);

        if(!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('Server response:', result);

        const finalId = (result.ok && result.callId) ? result.callId : provisionalId;
        
        console.log('Final Ticket ID:', finalId);

        ticketHeadline.innerHTML = '<span class="success">✅ Ticket Created Successfully!</span>';
        ticketInfo.innerHTML = `
          <strong style="font-size:15px">Ticket ID: ${finalId}</strong><br>
          <span style="font-size:13px">Type: ${data.type}</span><br>
          <span style="font-size:12px; margin-top:6px; display:block">
            ${result.ok ? 'Ticket saved successfully.' : 'Ticket created locally (server response pending).'} 
            Our team will contact you within 24 hours.
          </span>
        `;
        formNote.textContent = '';
        submitBtn.disabled = false;

        const waTo = (data.type && data.type.toLowerCase().includes('order')) ? ORDERS_WHATSAPP : OPS_WHATSAPP;
        const openWhatsApp = document.getElementById('openWhatsApp');
        const openEmail = document.getElementById('openEmail');
        const copyCallId = document.getElementById('copyCallId');
        
        openWhatsApp.href = buildWhatsAppLink(waTo, {...data, callId: finalId});
        openEmail.href = buildMailTo({...data, callId: finalId});

        copyCallId.onclick = () => {
          navigator.clipboard?.writeText(finalId).then(()=> {
            const originalText = copyCallId.textContent;
            copyCallId.textContent = '✅ Copied!';
            setTimeout(()=> {
              copyCallId.textContent = originalText;
            }, 2000);
          }).catch(()=> {
            alert('Copy failed. Call ID: ' + finalId);
          });
        };

        ticketResult.scrollIntoView({behavior: 'smooth', block: 'center'});
        
        if(!result.ok) {
          console.warn('Server returned non-ok response:', result);
          showErrorBanner(
            'Ticket created locally but not saved to server',
            'Your ticket ID is ' + finalId + '. Please contact support via WhatsApp or email.'
          );
        }
        
      } catch(err) {
        logError('handleFormSubmit', err);
        
        formNote.innerHTML = '';
        ticketHeadline.innerHTML = '<span class="error">❌ Submission Error</span>';
        ticketInfo.innerHTML = `
          <span style="font-size:13px">Unable to submit ticket: ${err.message}</span><br>
          <span style="font-size:12px; margin-top:6px; display:block">
            Please contact us directly via WhatsApp or email below.
          </span>
        `;
        ticketResult.style.display = 'block';
        submitBtn.disabled = false;
        
        showErrorBanner(
          'Failed to submit ticket',
          `Error: ${err.message}. Please contact support directly via WhatsApp or email.`
        );
      }
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en" data-theme="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contact • MakWell Support</title>
  <meta name="description" content="MakWell — product registration, support, repair requests, WhatsApp and email support." />
  <link rel="icon" href="https://raw.githubusercontent.com/Tarun1203/makwell-electronics/main/images/Makwell-logo.png">
  <link rel="stylesheet" href="styles.css" />
  <script defer src="theme.js"></script>

  <style>
    :root { --container: 1100px; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; color: var(--text); background: var(--bg); line-height: 1.6; }
    .container { max-width: var(--container); margin: 0 auto; padding: 16px; }
    
    header.site { border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    nav.container { display: flex; align-items: center; gap: 12px; justify-content: space-between; padding: 12px 16px; }
    .brand { display: flex; gap: 10px; align-items: center; text-decoration: none; color: inherit; transition: opacity 0.2s; }
    .brand:hover { opacity: 0.8; }
    .brand img { width: 40px; height: 40px; object-fit: contain; border-radius: 6px; }
    .navlinks { display: flex; gap: 10px; align-items: center; }
    .navlinks a { text-decoration: none; color: inherit; padding: 6px 12px; border-radius: 8px; transition: background 0.2s; font-size: 15px; }
    .navlinks a:hover { background: var(--hover); }
    .navlinks a.active { font-weight: 700; background: var(--hover); }

    main { padding: 20px 0 40px; }
    .hero { text-align: center; padding: 24px 0; }
    .hero h1 { margin: 4px 0; font-size: 32px; font-weight: 800; }
    .hero p { margin: 8px auto 0; max-width: 760px; }
    .two { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; margin-top: 24px; }
    @media (max-width: 900px) { .two { grid-template-columns: 1fr; } .hero h1 { font-size: 26px; } }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; box-shadow: var(--shadow); }
    .card h2, .card h3 { margin: 0 0 12px; font-weight: 700; }

    label { display: block; font-weight: 600; margin-top: 12px; margin-bottom: 6px; font-size: 14px; color: var(--text); }
    label:first-of-type { margin-top: 0; }
    input[type="text"], input[type="tel"], input[type="email"], select, textarea, input[type="date"] {
      width: 100%; padding: 11px 13px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: inherit; font: inherit; box-sizing: border-box; transition: all 0.2s; font-size: 15px;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
    input::placeholder, textarea::placeholder { color: var(--muted); }
    textarea { resize: vertical; min-height: 100px; font-family: inherit; }
    select { cursor: pointer; }

    .btn { display: inline-block; background: var(--accent); color: #fff; padding: 11px 18px; border-radius: 10px; border: 0; cursor: pointer; font-weight: 700; text-decoration: none; transition: all 0.2s; font-size: 15px; text-align: center; font-family: inherit; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.secondary { background: transparent; color: inherit; border: 1px solid var(--border); }
    .btn.secondary:hover { background: var(--hover); opacity: 1; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    .note { font-size: 13px; color: var(--muted); margin-top: 6px; line-height: 1.5; }
    .small { font-size: 13px; color: var(--muted); }
    .result { margin-top: 16px; padding: 16px; border-radius: 10px; border: 1px solid var(--border); background: color-mix(in oklab, var(--accent) 6%, var(--bg)); animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .success { color: #28a745; font-weight: 700; }
    .error { color: #dc3545; font-weight: 700; }
    .warning { color: #ff6b00; font-weight: 600; }

    .warranty-badge { display: inline-block; padding: 10px 18px; border-radius: 20px; font-size: 14px; font-weight: 700; margin-top: 12px; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .warranty-badge.valid { background: #28a745; color: white; }
    .warranty-badge.expired { background: #dc3545; color: white; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .grid-2:first-of-type { margin-top: 0; }
    @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }

    footer.site { text-align: center; padding: 30px 12px; border-top: 1px solid var(--border); margin-top: 50px; background: var(--panel); }
    #warrantyChecker { animation: slideIn 0.3s ease; margin-bottom: 24px; }

    .contact-item { margin-bottom: 14px; padding: 10px; border-radius: 8px; transition: background 0.2s; }
    .contact-item:hover { background: var(--hover); }
    .contact-item strong { display: block; margin-bottom: 4px; font-size: 14px; }
    .contact-item a { color: var(--accent); text-decoration: none; font-weight: 500; }
    .contact-item a:hover { text-decoration: underline; }

    .required-star { color: #dc3545; font-weight: 700; }
    
    .error-banner { background: #f8d7da; color: #721c24; padding: 12px 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #dc3545; }
    .error-banner strong { display: block; margin-bottom: 4px; }
    
    @media (max-width: 600px) { .card { padding: 18px; } nav.container { flex-wrap: wrap; } .navlinks { font-size: 14px; } }
  </style>
</head>
<body>
  <header class="site">
    <nav class="container" aria-label="Main navigation">
      <a class="brand" href="index.html" aria-label="MakWell home">
        <img src="https://raw.githubusercontent.com/Tarun1203/makwell-electronics/main/images/Makwell-logo.png" alt="MakWell logo">
        <div>
          <div style="font-weight:800; font-size:18px">MakWell</div>
          <div class="small">Make it Happen</div>
        </div>
      </a>
      <div class="navlinks" role="navigation" aria-label="Top links">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="about.html">About</a>
        <a href="contact.html" class="active">Contact</a>
        <button id="themeToggle" aria-label="Toggle theme" onclick="toggleTheme()" class="btn secondary" style="padding:8px 12px; font-size:18px">🌓</button>
      </div>
    </nav>
  </header>

  <main class="container">
    <section class="hero">
      <h1 id="pageTitle">Need help? Submit a request</h1>
      <p class="small muted" id="pageDesc">Product registration, product support, and repair requests — use the form below.</p>
      <div id="warrantyBadgeContainer"></div>
    </section>

    <section id="mainContent">
      <div class="two">
        <form id="supportForm" class="card" autocomplete="on" novalidate>
          <h2>Create Ticket</h2>

          <label for="type">Request Type <span class="required-star">*</span></label>
          <select id="type" required>
            <option value="">Select request type</option>
            <option value="Product Registration">Product Registration</option>
            <option value="Product Support">Product Support</option>
            <option value="Repair Request">Repair Request</option>
          </select>

          <div class="grid-2">
            <div>
              <label for="customer">Customer Name <span class="required-star">*</span></label>
              <input id="customer" type="text" placeholder="Full name" required autocomplete="name">
            </div>
            <div>
              <label for="phone">Phone <span class="required-star">*</span></label>
              <input id="phone" type="tel" placeholder="10-digit mobile" pattern="[0-9]{10}" required autocomplete="tel">
            </div>
          </div>

          <label for="email">Email (optional)</label>
          <input id="email" type="email" placeholder="name@example.com" autocomplete="email">

          <div class="grid-2">
            <div>
              <label for="category">Product Category <span class="required-star">*</span></label>
              <select id="category" required>
                <option value="">Select category</option>
                <option value="Televisions">Televisions</option>
                <option value="Washing Machines">Washing Machines</option>
                <option value="Refrigerators">Refrigerators</option>
                <option value="Air Conditioners">Air Conditioners</option>
                <option value="Stabilizers">Stabilizers</option>
                <option value="Microwave Ovens">Microwave Ovens</option>
                <option value="Water Purifiers">Water Purifiers</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label for="model">Model <span class="required-star">*</span></label>
              <input id="model" type="text" placeholder='e.g., 43" Smart TV' required>
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label for="serial">Serial Number (optional)</label>
              <input id="serial" type="text" placeholder="Serial number">
            </div>
            <div>
              <label for="purchaseDate">Purchase Date <span id="purchaseDateRequired"></span></label>
              <input id="purchaseDate" type="date" max="">
            </div>
          </div>

          <div class="grid-2" id="warrantySection">
            <div>
              <label for="warranty">Under Warranty <span class="required-star">*</span></label>
              <select id="warranty" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div id="warrantyNote" class="note" aria-live="polite"></div>
            </div>
            <div id="issueTypeSection">
              <label for="issueType">Issue Type (optional)</label>
              <select id="issueType">
                <option value="">—</option>
                <option value="Installation">Installation</option>
                <option value="Usage Help">Usage Help</option>
                <option value="Connectivity">Connectivity</option>
                <option value="No Power">No Power</option>
                <option value="Physical Damage">Physical Damage</option>
                <option value="Noise/Vibration">Noise/Vibration</option>
                <option value="Performance Issue">Performance Issue</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <label for="issue">Issue Description <span id="issueRequired"></span></label>
          <textarea id="issue" placeholder="Brief description of the issue or request"></textarea>

          <div class="grid-2">
            <div>
              <label for="city">City</label>
              <input id="city" type="text" placeholder="City">
            </div>
            <div>
              <label for="state">State</label>
              <input id="state" type="text" placeholder="State">
            </div>
          </div>

          <div id="formNote" class="note" style="margin-top:14px; min-height:20px; font-weight:600" aria-live="polite"></div>

          <div style="margin-top:18px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <button id="submitBtn" class="btn" type="submit">Create Ticket</button>
            <button type="reset" class="btn secondary">Clear Form</button>
          </div>

          <div id="ticketResult" class="result" style="display:none" aria-live="polite">
            <div><strong id="ticketHeadline" style="font-size:16px"></strong></div>
            <div id="ticketInfo" class="small" style="margin-top:8px"></div>
            <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap">
              <a id="openWhatsApp" class="btn" target="_blank" rel="noopener">📱 Open WhatsApp</a>
              <a id="openEmail" class="btn secondary" target="_blank" rel="noopener">✉️ Email</a>
              <button id="copyCallId" class="btn secondary">📋 Copy ID</button>
            </div>
          </div>
        </form>

        <aside>
          <div class="card">
            <h3>Quick Contacts</h3>
            <p class="small muted" style="margin:0 0 14px">For immediate assistance:</p>
            
            <div class="contact-item">
              <strong>📦 Orders / Live Chat</strong>
              <a href="https://api.whatsapp.com/send?phone=919980000515" target="_blank" rel="noopener">+91 99800 00515</a>
            </div>
            
            <div class="contact-item">
              <strong>🔧 Service / Repair</strong>
              <a href="https://api.whatsapp.com/send?phone=919482844677" target="_blank" rel="noopener">+91 94828 44677</a>
            </div>
            
            <div class="contact-item">
              <strong>✉️ Email Support</strong>
              <a href="mailto:makwellindia456@gmail.com">makwellindia456@gmail.com</a>
            </div>
            
            <hr style="margin:16px 0; border:none; border-top:1px solid var(--border)">
            
            <p class="small muted" style="margin:0 0 16px">
              <strong>Support Hours:</strong><br>Monday–Saturday<br>9:30 AM – 6:30 PM IST
            </p>

            <div style="display:flex; flex-direction:column; gap:10px">
              <a href="contact.html?action=register" class="btn secondary">📝 Register Product</a>
              <a href="contact.html?action=warranty" class="btn secondary">🛡️ Check Warranty</a>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <footer class="site">
    <div class="container small muted">© <span id="year"></span> MakWell — Make it Happen</div>
  </footer>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyPsg7-re-YDPTyPUuxIHnwW1HBrssztbLOca3JvguyIBlCOK5EhwNohYdGsqkcK-Gy/exec";
    const WEB_SECRET = "MakWell2024SecureKey";
    const OPS_WHATSAPP = "919482844677";
    const ORDERS_WHATSAPP = "919980000515";

    const WARRANTY_PERIODS = {
      'Televisions': 12, 'Washing Machines': 24, 'Refrigerators': 12,
      'Air Conditioners': 12, 'Stabilizers': 12, 'Microwave Ovens': 12,
      'Water Purifiers': 12, 'Other': 12, 'Default': 12
    };

    // ========================================
    // ERROR LOGGING
    // ========================================
    function logError(context, error) {
      console.error(`[${context}] Error:`, error);
      if(error.stack) console.error('Stack:', error.stack);
    }

    function showErrorBanner(message, details = '') {
      const banner = document.createElement('div');
      banner.className = 'error-banner';
      banner.innerHTML = `
        <strong>❌ Error</strong>
        ${message}
        ${details ? `<div class="small" style="margin-top:6px">${details}</div>` : ''}
      `;
      document.querySelector('main .container').insertBefore(banner, document.getElementById('mainContent'));
      setTimeout(() => banner.remove(), 10000);
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function getUrlParam(param) {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      } catch(e) {
        logError('getUrlParam', e);
        return null;
      }
    }

    function prefixFor(type){
      if(!type) return "XX";
      if(type.includes("Registration")) return "PR";
      if(type.includes("Support")) return "PS";
      if(type.includes("Repair")) return "RR";
      return "XX";
    }

    function pad3(n){ return String(n).padStart(3,'0'); }
    function twoDigitYear(){ return new Date().getFullYear().toString().slice(-2); }

    // ========================================
    // WARRANTY CALCULATION
    // ========================================
    function calculateWarrantyExpiry(purchaseDate, category) {
      try {
        if(!purchaseDate) return null;
        const purchase = new Date(purchaseDate);
        if(isNaN(purchase.getTime())) return null;
        
        const warrantyMonths = WARRANTY_PERIODS[category] || WARRANTY_PERIODS['Default'];
        const expiry = new Date(purchase);
        expiry.setMonth(expiry.getMonth() + warrantyMonths);
        return expiry;
      } catch(e) {
        logError('calculateWarrantyExpiry', e);
        return null;
      }
    }

    function isUnderWarranty(purchaseDate, category) {
      try {
        const expiryDate = calculateWarrantyExpiry(purchaseDate, category);
        if(!expiryDate) return false;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return today <= expiryDate;
      } catch(e) {
        logError('isUnderWarranty', e);
        return false;
      }
    }

    function getRemainingWarrantyDays(purchaseDate, category) {
      try {
        const expiryDate = calculateWarrantyExpiry(purchaseDate, category);
        if(!expiryDate) return 0;
        const today = new Date();
        const diffTime = expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return Math.max(0, diffDays);
      } catch(e) {
        logError('getRemainingWarrantyDays', e);
        return 0;
      }
    }

    // ========================================
    // AUTO-CHECK WARRANTY
    // ========================================
    function autoCheckWarranty() {
      try {
        const purchaseDate = document.getElementById('purchaseDate').value;
        const category = document.getElementById('category').value;
        const warrantyField = document.getElementById('warranty');
        const warrantyNote = document.getElementById('warrantyNote');
        const badgeContainer = document.getElementById('warrantyBadgeContainer');
        
        if(!purchaseDate || !category) {
          warrantyNote.innerHTML = '';
          badgeContainer.innerHTML = '';
          return;
        }
        
        const underWarranty = isUnderWarranty(purchaseDate, category);
        const remainingDays = getRemainingWarrantyDays(purchaseDate, category);
        const expiryDate = calculateWarrantyExpiry(purchaseDate, category);
        
        if(!expiryDate) {
          warrantyNote.innerHTML = '<span class="error">Invalid purchase date</span>';
          return;
        }
        
        warrantyField.value = underWarranty ? 'Yes' : 'No';
        
        if(underWarranty) {
          warrantyNote.innerHTML = `
            <span class="success">✓ Under Warranty</span><br>
            <span style="font-size:12px">${remainingDays} days remaining • Expires: ${expiryDate.toLocaleDateString('en-IN')}</span>
          `;
          badgeContainer.innerHTML = `<div class="warranty-badge valid">✓ Valid Warranty • ${remainingDays} days remaining</div>`;
        } else {
          warrantyNote.innerHTML = `
            <span class="error">✗ Warranty Expired</span><br>
            <span style="font-size:12px">Expired: ${expiryDate.toLocaleDateString('en-IN')}</span>
          `;
          badgeContainer.innerHTML = `<div class="warranty-badge expired">✗ Warranty Expired</div>`;
        }
        
        maybeWarn();
      } catch(e) {
        logError('autoCheckWarranty', e);
      }
    }

    // ========================================
    // FORM VALIDATION
    // ========================================
    function maybeWarn(){
      try {
        const type = document.getElementById('type').value;
        const warranty = document.getElementById('warranty').value;
        const purchaseDate = document.getElementById('purchaseDate').value;
        const category = document.getElementById('category').value;
        const formNote = document.getElementById('formNote');
        
        if(type === 'Product Support' && warranty && warranty !== 'Yes'){
          formNote.innerHTML = `
            <span class="warning">⚠ Product Support requires active warranty.</span><br>
            <span style="font-size:12px">This will be logged as <strong>Repair Request</strong> (chargeable service).</span>
          `;
        } 
        else if(warranty === 'Yes' && purchaseDate && category) {
          const actuallyUnderWarranty = isUnderWarranty(purchaseDate, category);
          if(!actuallyUnderWarranty) {
            formNote.innerHTML = `<span class="warning">⚠ Warning:</span> Based on purchase date, warranty appears expired. Please verify.`;
          } else {
            formNote.textContent = "";
          }
        }
        else {
          formNote.textContent = "";
        }
      } catch(e) {
        logError('maybeWarn', e);
      }
    }

    // ========================================
    // LINK BUILDERS
    // ========================================
    function buildWhatsAppLink(phone, obj){
      try {
        const p = String(phone||"").replace(/\D/g,'');
        const lines = [
          `📋 Call ID: ${obj.callId}`, `📌 Type: ${obj.type}`, `👤 Name: ${obj.customer}`,
          `📱 Phone: +91 ${obj.phone}`, `📧 Email: ${obj.email || '-'}`, ``,
          `🏷️ Category: ${obj.category || '-'}`, `📦 Model: ${obj.model || '-'}`,
          `🔢 Serial: ${obj.serial || '-'}`, `📅 Purchase Date: ${obj.purchaseDate || '-'}`,
          `🛡️ Under Warranty: ${obj.warranty || '-'}`, ``,
          `⚠️ Issue Type: ${obj.issueType || '-'}`, `📝 Description: ${obj.issue || '-'}`, ``,
          `📍 Location: ${obj.city || '-'}, ${obj.state || '-'}`
        ];
        return `https://api.whatsapp.com/send?phone=${p}&text=${encodeURIComponent(lines.join("\n"))}`;
      } catch(e) {
        logError('buildWhatsAppLink', e);
        return `https://api.whatsapp.com/send?phone=${phone}`;
      }
    }

    function buildMailTo(obj){
      try {
        const sub = `New ${obj.type} Ticket - ${obj.callId}`;
        const body = [
          `Call ID: ${obj.callId}`, `Type: ${obj.type}`, ``, `CUSTOMER DETAILS:`,
          `Name: ${obj.customer}`, `Phone: +91 ${obj.phone}`, `Email: ${obj.email || '-'}`, ``,
          `PRODUCT DETAILS:`, `Category: ${obj.category || '-'}`, `Model: ${obj.model || '-'}`,
          `Serial: ${obj.serial || '-'}`, `Purchase Date: ${obj.purchaseDate || '-'}`,
          `Under Warranty: ${obj.warranty || '-'}`, ``, `ISSUE DETAILS:`,
          `Issue Type: ${obj.issueType || '-'}`, `Description: ${obj.issue || '-'}`, ``,
          `LOCATION:`, `City: ${obj.city || '-'}`, `State: ${obj.state || '-'}`
        ].join("\n");
        return `mailto:makwellindia456@gmail.com?subject=${encodeURIComponent(sub)}&body=${encodeURIComponent(body)}`;
      } catch(e) {
        logError('buildMailTo', e);
        return 'mailto:makwellindia456@gmail.com';
      }
    }

    // ========================================
    // WARRANTY CHECKER
    // ========================================
    function showWarrantyChecker() {
      try {
        const warrantyCheckerHTML = `
          <div class="card" id="warrantyChecker">
            <h2>Check Warranty Status</h2>
            <p class="small muted">Enter your product details to verify warranty status.</p>
            <div class="grid-2" style="margin-top:16px">
              <div>
                <label for="checkSerial">Serial Number <span class="required-star">*</span></label>
                <input id="checkSerial" type="text" placeholder="Enter serial number" required>
              </div>
              <div>
                <label for="checkPhone">Registered Phone <span class="required-star">*</span></label>
                <input id="checkPhone" type="tel" placeholder="10-digit mobile" pattern="[0-9]{10}" required>
              </div>
            </div>
            <button id="checkWarrantyBtn" class="btn" style="margin-top:14px">🔍 Check Warranty Status</button>
            <div id="warrantyResult" class="result" style="display:none; margin-top:14px">
              <div id="warrantyStatus"></div>
            </div>
          </div>
        `;
        
        const mainContent = document.getElementById('mainContent');
        mainContent.insertAdjacentHTML('afterbegin', warrantyCheckerHTML);
        document.getElementById('checkWarrantyBtn').addEventListener('click', checkWarrantyStatus);
      } catch(e) {
        logError('showWarrantyChecker', e);
      }
    }

    async function checkWarrantyStatus() {
      const serial = document.getElementById('checkSerial').value.trim();
      const phone = document.getElementById('checkPhone').value.trim();
      const resultDiv = document.getElementById('warrantyResult');
      const statusDiv = document.getElementById('warrantyStatus');
      const btn = document.getElementById('checkWarrantyBtn');
      
      try {
        if(!serial || !phone) {
          statusDiv.innerHTML = '<span class="error">⚠ Please enter both serial number and phone.</span>';
          resultDiv.style.display = 'block';
          return;
        }

        if(!/^[0-9]{10}$/.test(phone)) {
          statusDiv.innerHTML = '<span class="error">⚠ Phone number must be 10 digits.</span>';
          resultDiv.style.display = 'block';
          return;
        }
        
        btn.disabled = true;
        btn.textContent = '🔍 Checking...';
        statusDiv.innerHTML = '<span>🔍 Searching warranty records...</span>';
        resultDiv.style.display = 'block';
        
        console.log('Checking warranty for:', { serial, phone });
        
        const response = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            action: 'checkWarranty',
            serial: serial,
            phone: phone,
            secret: WEB_SECRET
          })
        });
        
        console.log('Response status:', response.status);
        
        if(!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Warranty check result:', result);
        
        if(result.found) {
          const underWarranty = isUnderWarranty(result.purchaseDate, result.category);
          const remainingDays = getRemainingWarrantyDays(result.purchaseDate, result.category);
          const expiryDate = calculateWarrantyExpiry(result.purchaseDate, result.category);
          
          const bgColor = underWarranty ? '#d4edda' : '#f8d7da';
          const textColor = underWarranty ? '#155724' : '#721c24';
          const warrantyMonths = WARRANTY_PERIODS[result.category] || 12;
          
          statusDiv.innerHTML = `
            <div style="margin-bottom:14px; padding-bottom:14px; border-bottom:1px solid var(--border)">
              <strong style="font-size:15px">Product Information</strong><br>
              <div style="margin-top:8px; line-height:1.8">
                <strong>Model:</strong> ${result.model || 'N/A'}<br>
                <strong>Category:</strong> ${result.category || 'N/A'}<br>
                <strong>Serial Number:</strong> ${result.serial || 'N/A'}<br>
                <strong>Customer:</strong> ${result.customer || 'N/A'}
              </div>
            </div>
            <div style="margin-bottom:14px; padding-bottom:14px; border-bottom:1px solid var(--border)">
              <strong style="font-size:15px">Warranty Information</strong><br>
              <div style="margin-top:8px; line-height:1.8">
                <strong>Purchase Date:</strong> ${new Date(result.purchaseDate).toLocaleDateString('en-IN')}<br>
                <strong>Warranty Period:</strong> ${warrantyMonths} months<br>
                <strong>Warranty Expiry:</strong> ${expiryDate.toLocaleDateString('en-IN')}
              </div>
            </div>
            <div style="padding:14px; border-radius:8px; background:${bgColor}; color:${textColor}; font-weight:700; text-align:center; font-size:16px">
              ${underWarranty 
                ? `✓ UNDER WARRANTY<br><span style="font-size:14px; font-weight:400;
