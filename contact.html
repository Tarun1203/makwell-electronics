// ========================================
// CONFIGURATION
// ========================================

const SHEET_ID = '1hX15ATTRJTuMMccfrN-CJtNDViOb2lJ2odgCWD-kEqY';

// Sheet names for different request types
const SHEET_NAMES = {
  'Product Registration': 'Registrations',
  'Product Support': 'Support',
  'Repair Request': 'Repairs',
  'Default': 'All Tickets'
};

// Warranty periods in months (must match frontend)
const WARRANTY_PERIODS = {
  'Televisions': 12,
  'Washing Machines': 24,
  'Refrigerators': 12,
  'Air Conditioners': 12,
  'Stabilizers': 12,
  'Microwave Ovens': 12,
  'Water Purifiers': 12,
  'Other': 12,
  'Default': 12
};

// ========================================
// MAIN HANDLER
// ========================================

function doPost(e) {
  try {
    const data = JSON.parse(e.postBody);
    
    // Verify secret key
    const storedSecret = PropertiesService.getScriptProperties().getProperty('SECRET');
    if(data.secret !== storedSecret) {
      return jsonResponse({ok: false, error: 'Unauthorized', message: 'Invalid secret key'});
    }
    
    // Route to appropriate handler
    if(data.action === 'checkWarranty') {
      return handleWarrantyCheck(data);
    } else {
      return handleTicketCreation(data);
    }
  } catch(err) {
    Logger.log('Error in doPost: ' + err.toString());
    return jsonResponse({ok: false, error: err.toString()});
  }
}

// For testing
function doGet(e) {
  return ContentService.createTextOutput('MakWell Support API is running. Use POST requests.');
}

// ========================================
// TICKET CREATION HANDLER
// ========================================

function handleTicketCreation(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    
    // Get or create appropriate sheet
    const sheetName = SHEET_NAMES[data.type] || SHEET_NAMES['Default'];
    let sheet = ss.getSheetByName(sheetName);
    
    if(!sheet) {
      sheet = ss.insertSheet(sheetName);
      // Add headers
      sheet.appendRow([
        'Timestamp', 'Call ID', 'Type', 'Customer', 'Phone', 'Email',
        'Category', 'Model', 'Serial', 'Purchase Date', 'Warranty',
        'Issue Type', 'Issue', 'City', 'State', 'Source', 'Status'
      ]);
      sheet.getRange(1, 1, 1, 17).setFontWeight('bold').setBackground('#4285f4').setFontColor('#ffffff');
      sheet.setFrozenRows(1);
    }
    
    // Generate Call ID
    const callId = generateCallId(data.type, sheet);
    
    // Prepare row data
    const timestamp = new Date();
    const rowData = [
      timestamp,
      callId,
      data.type || '',
      data.customer || '',
      data.phone || '',
      data.email || '',
      data.category || '',
      data.model || '',
      data.serial || '',
      data.purchaseDate || '',
      data.warranty || '',
      data.issueType || '',
      data.issue || '',
      data.city || '',
      data.state || '',
      data.source || 'Web Form',
      'Open'
    ];
    
    // Append to sheet
    sheet.appendRow(rowData);
    
    // Format the new row
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow, 1, 1, 17).setHorizontalAlignment('left');
    
    // Set column widths (only if newly created)
    if(lastRow === 2) {
      sheet.setColumnWidth(1, 150); // Timestamp
      sheet.setColumnWidth(2, 130); // Call ID
      sheet.setColumnWidth(3, 150); // Type
      sheet.setColumnWidth(4, 150); // Customer
      sheet.setColumnWidth(5, 110); // Phone
      sheet.setColumnWidth(6, 200); // Email
      sheet.setColumnWidth(7, 120); // Category
      sheet.setColumnWidth(8, 150); // Model
    }
    
    // Also log to "All Tickets" sheet for master record
    logToAllTickets(ss, rowData);
    
    // Send notification email (optional)
    sendNotificationEmail(data, callId);
    
    return jsonResponse({
      ok: true,
      callId: callId,
      message: 'Ticket created successfully',
      timestamp: timestamp.toISOString()
    });
    
  } catch(err) {
    Logger.log('Error in handleTicketCreation: ' + err.toString());
    return jsonResponse({ok: false, error: err.toString()});
  }
}

// ========================================
// WARRANTY CHECK HANDLER
// ========================================

function handleWarrantyCheck(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const regSheet = ss.getSheetByName('Registrations');
    
    if(!regSheet) {
      return jsonResponse({
        found: false,
        message: 'Registration sheet not found'
      });
    }
    
    const records = regSheet.getDataRange().getValues();
    
    // Search for matching record (skip header row)
    for(let i = 1; i < records.length; i++) {
      const row = records[i];
      // Columns: [Timestamp, CallID, Type, Customer, Phone, Email, Category, Model, Serial, PurchaseDate, ...]
      const rowSerial = String(row[8] || '').trim();
      const rowPhone = String(row[4] || '').trim();
      
      if(rowSerial === data.serial && rowPhone === data.phone) {
        return jsonResponse({
          found: true,
          customer: row[3],
          phone: row[4],
          email: row[5] || '',
          category: row[6],
          model: row[7],
          serial: row[8],
          purchaseDate: formatDateForJS(row[9]),
          callId: row[1]
        });
      }
    }
    
    return jsonResponse({
      found: false,
      message: 'No matching registration found'
    });
    
  } catch(err) {
    Logger.log('Error in handleWarrantyCheck: ' + err.toString());
    return jsonResponse({found: false, error: err.toString()});
  }
}

// ========================================
// HELPER FUNCTIONS
// ========================================

function generateCallId(type, sheet) {
  const year = new Date().getFullYear().toString().slice(-2);
  
  // Determine prefix
  let prefix = 'XX';
  if(type && type.includes('Registration')) prefix = 'PR';
  else if(type && type.includes('Support')) prefix = 'PS';
  else if(type && type.includes('Repair')) prefix = 'RR';
  
  // Count existing records for this type to get sequential number
  const data = sheet.getDataRange().getValues();
  let count = 0;
  for(let i = 1; i < data.length; i++) {
    if(data[i][1] && data[i][1].toString().includes(prefix)) {
      count++;
    }
  }
  
  const seqNum = String(count + 1).padStart(3, '0');
  return `${year}/MK-${prefix}-${seqNum}`;
}

function logToAllTickets(ss, rowData) {
  try {
    let allSheet = ss.getSheetByName('All Tickets');
    
    if(!allSheet) {
      allSheet = ss.insertSheet('All Tickets');
      allSheet.appendRow([
        'Timestamp', 'Call ID', 'Type', 'Customer', 'Phone', 'Email',
        'Category', 'Model', 'Serial', 'Purchase Date', 'Warranty',
        'Issue Type', 'Issue', 'City', 'State', 'Source', 'Status'
      ]);
      allSheet.getRange(1, 1, 1, 17).setFontWeight('bold').setBackground('#34a853').setFontColor('#ffffff');
      allSheet.setFrozenRows(1);
    }
    
    allSheet.appendRow(rowData);
  } catch(err) {
    Logger.log('Error logging to All Tickets: ' + err.toString());
  }
}

function sendNotificationEmail(data, callId) {
  try {
    const email = PropertiesService.getScriptProperties().getProperty('NOTIFICATION_EMAIL');
    if(!email) return;
    
    const subject = `🔔 New ${data.type} - ${callId}`;
    const body = `
New Support Ticket Created
═══════════════════════════════════════

TICKET INFORMATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Call ID: ${callId}
Type: ${data.type}
Status: Open
Timestamp: ${new Date().toLocaleString('en-IN', {timeZone: 'Asia/Kolkata'})}

CUSTOMER DETAILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Name: ${data.customer}
Phone: +91 ${data.phone}
Email: ${data.email || 'Not provided'}

PRODUCT INFORMATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Category: ${data.category}
Model: ${data.model}
Serial Number: ${data.serial || 'Not provided'}
Purchase Date: ${data.purchaseDate || 'Not provided'}
Under Warranty: ${data.warranty}

ISSUE DETAILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Issue Type: ${data.issueType || 'Not specified'}
Description: ${data.issue || 'No description provided'}

LOCATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
City: ${data.city || 'Not provided'}
State: ${data.state || 'Not provided'}

SOURCE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${data.source}

═══════════════════════════════════════
View in Google Sheets:
https://docs.google.com/spreadsheets/d/${SHEET_ID}

WhatsApp Quick Response:
https://api.whatsapp.com/send?phone=91${data.phone}

═══════════════════════════════════════
MakWell Support System
    `;
    
    MailApp.sendEmail({
      to: email,
      subject: subject,
      body: body
    });
  } catch(err) {
    Logger.log('Error sending email: ' + err.toString());
  }
}

function formatDateForJS(dateValue) {
  if(!dateValue) return '';
  
  // If it's already a Date object
  if(dateValue instanceof Date) {
    return Utilities.formatDate(dateValue, Session.getScriptTimeZone(), 'yyyy-MM-dd');
  }
  
  // If it's a string
  if(typeof dateValue === 'string') {
    return dateValue;
  }
  
  return '';
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

// ========================================
// UTILITY FUNCTIONS FOR SHEET MANAGEMENT
// ========================================

function createAllRequiredSheets() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheetsToCreate = ['Registrations', 'Support', 'Repairs', 'All Tickets'];
  
  const headers = [
    'Timestamp', 'Call ID', 'Type', 'Customer', 'Phone', 'Email',
    'Category', 'Model', 'Serial', 'Purchase Date', 'Warranty',
    'Issue Type', 'Issue', 'City', 'State', 'Source', 'Status'
  ];
  
  const colors = {
    'Registrations': '#4285f4',
    'Support': '#34a853',
    'Repairs': '#ea4335',
    'All Tickets': '#fbbc04'
  };
  
  sheetsToCreate.forEach(sheetName => {
    let sheet = ss.getSheetByName(sheetName);
    if(!sheet) {
      sheet = ss.insertSheet(sheetName);
      sheet.appendRow(headers);
      sheet.getRange(1, 1, 1, headers.length)
        .setFontWeight('bold')
        .setBackground(colors[sheetName] || '#4285f4')
        .setFontColor('#ffffff');
      
      // Set column widths
      sheet.setColumnWidth(1, 150); // Timestamp
      sheet.setColumnWidth(2, 130); // Call ID
      sheet.setColumnWidth(3, 150); // Type
      sheet.setColumnWidth(4, 150); // Customer
      sheet.setColumnWidth(5, 110); // Phone
      sheet.setColumnWidth(6, 200); // Email
      sheet.setColumnWidth(7, 120); // Category
      sheet.setColumnWidth(8, 150); // Model
      sheet.setColumnWidth(9, 120); // Serial
      sheet.setColumnWidth(10, 120); // Purchase Date
      
      // Freeze header row
      sheet.setFrozenRows(1);
      
      Logger.log('Created sheet: ' + sheetName);
    }
  });
  
  Logger.log('✅ All required sheets created/verified');
}

// Run this once to set up your sheets
function setupSheets() {
  createAllRequiredSheets();
}

// ========================================
// TESTING FUNCTIONS
// ========================================

function testTicketCreation() {
  const testData = {
    secret: PropertiesService.getScriptProperties().getProperty('SECRET'),
    type: 'Product Support',
    customer: 'Test Customer',
    phone: '9876543210',
    email: 'test@example.com',
    category: 'Televisions',
    model: '43" Smart TV',
    serial: 'TEST12345',
    purchaseDate: '2024-10-01',
    warranty: 'Yes',
    issueType: 'No Power',
    issue: 'TV not turning on',
    city: 'Bangalore',
    state: 'Karnataka',
    source: 'Test Script'
  };
  
  const result = handleTicketCreation(testData);
  Logger.log(result.getContent());
}

function testWarrantyCheck() {
  const testData = {
    secret: PropertiesService.getScriptProperties().getProperty('SECRET'),
    action: 'checkWarranty',
    serial: 'TEST12345',
    phone: '9876543210'
  };
  
  const result = handleWarrantyCheck(testData);
  Logger.log(result.getContent());
}

function testEmailNotification() {
  const testData = {
    type: 'Product Support',
    customer: 'Test Customer',
    phone: '9876543210',
    email: 'test@example.com',
    category: 'Televisions',
    model: '43" Smart TV',
    serial: 'TEST12345',
    purchaseDate: '2024-10-01',
    warranty: 'Yes',
    issueType: 'No Power',
    issue: 'TV not turning on',
    city: 'Bangalore',
    state: 'Karnataka',
    source: 'Test'
  };
  
  sendNotificationEmail(testData, '25/MK-PS-001');
  Logger.log('✅ Test email sent');
}
